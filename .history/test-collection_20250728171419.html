<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>小红书数据采集测试</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background: #f5f5f5;
        }
        .test-container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .mock-xhs-page {
            background: #fff;
            min-height: 800px;
            padding: 20px;
            border-radius: 8px;
            border: 2px dashed #ddd;
        }
        .note-item {
            display: inline-block;
            width: 236px;
            margin: 10px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            vertical-align: top;
        }
        .cover {
            display: block;
            width: 100%;
            height: 315px;
            overflow: hidden;
            position: relative;
        }
        .cover img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .footer {
            padding: 12px;
        }
        .title {
            display: block;
            color: #333;
            text-decoration: none;
            font-size: 14px;
            line-height: 1.4;
            margin-bottom: 8px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .author-wrapper {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .author {
            display: flex;
            align-items: center;
            color: #666;
            text-decoration: none;
            font-size: 12px;
        }
        .author-avatar {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 6px;
        }
        .like-wrapper {
            display: flex;
            align-items: center;
            color: #666;
            font-size: 12px;
        }
        .like-wrapper .count {
            margin-left: 4px;
        }
        .control-panel {
            position: fixed;
            top: 20px;
            right: 20px;
            width: 300px;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            z-index: 1000;
        }
        .status {
            padding: 10px;
            border-radius: 6px;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
        }
        .status.running {
            background: #d4edda;
            color: #155724;
        }
        .status.stopped {
            background: #f8d7da;
            color: #721c24;
        }
        .status.paused {
            background: #fff3cd;
            color: #856404;
        }
        button {
            background: #007bff;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            margin: 2px;
            font-size: 12px;
        }
        button:hover {
            background: #0056b3;
        }
        button:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        .data-preview {
            max-height: 200px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px;
            margin-top: 10px;
            font-size: 12px;
        }
        .data-item {
            padding: 8px;
            border-bottom: 1px solid #eee;
        }
        .data-item:last-child {
            border-bottom: none;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
            font-family: monospace;
            font-size: 11px;
            max-height: 150px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <!-- 控制面板 -->
    <div class="control-panel">
        <h3>采集控制面板</h3>
        <div id="status" class="status stopped">待启动</div>
        <div>
            <strong>数据统计:</strong> <span id="dataCount">0</span> 条
        </div>
        <div>
            <strong>运行时间:</strong> <span id="runtime">00:00:00</span>
        </div>
        <div style="margin: 15px 0;">
            <button id="startBtn" onclick="startCollection()">开始采集</button>
            <button id="pauseBtn" onclick="pauseCollection()" disabled>暂停</button>
            <button id="stopBtn" onclick="stopCollection()" disabled>停止</button>
        </div>
        <div>
            <button onclick="addMoreNotes()">加载更多笔记</button>
            <button onclick="clearLogs()">清除日志</button>
        </div>
        <div class="data-preview" id="dataPreview">
            <div style="text-align: center; color: #999;">暂无数据</div>
        </div>
        <div class="log" id="logArea"></div>
    </div>

    <!-- 模拟小红书页面 -->
    <div class="test-container">
        <h1>小红书数据采集功能测试</h1>
        <p>这是一个模拟的小红书页面，用于测试数据采集功能。</p>
    </div>

    <div class="mock-xhs-page" id="mockPage">
        <!-- 模拟笔记卡片将在这里动态生成 -->
    </div>

    <!-- 模拟Chrome扩展环境 -->
    <script>
        // 模拟Chrome扩展API
        if (!window.chrome) {
            window.chrome = {
                runtime: {
                    onMessage: {
                        addListener: function(callback) {
                            window.chromeMessageListener = callback;
                        }
                    },
                    sendMessage: function(message, callback) {
                        console.log('模拟发送消息:', message);
                        if (callback) callback({ success: true });
                    }
                },
                storage: {
                    local: {
                        get: function(keys) {
                            return Promise.resolve({ collectedData: window.mockCollectedData || [] });
                        },
                        set: function(data) {
                            if (data.collectedData) {
                                window.mockCollectedData = data.collectedData;
                            }
                            return Promise.resolve();
                        }
                    },
                    sync: {
                        get: function(keys) {
                            const settings = localStorage.getItem('xhs-plugin-settings');
                            return Promise.resolve({ settings: settings ? JSON.parse(settings) : null });
                        },
                        set: function(data) {
                            if (data.settings) {
                                localStorage.setItem('xhs-plugin-settings', JSON.stringify(data.settings));
                            }
                            return Promise.resolve();
                        }
                    }
                },
                tabs: {
                    query: function(queryInfo) {
                        return Promise.resolve([{
                            id: 1,
                            url: 'https://www.xiaohongshu.com/search_result?keyword=test'
                        }]);
                    },
                    sendMessage: function(tabId, message, callback) {
                        // 模拟向content script发送消息
                        if (window.mockContentScript) {
                            const response = window.mockContentScript.handleMessage(message);
                            if (callback) callback(response);
                        }
                    }
                }
            };
        }
    </script>

    <!-- 加载工具脚本 -->
    <script src="utils/data-parser.js"></script>
    <script src="content/content.js"></script>

    <script>
        // 全局变量
        let isRunning = false;
        let isPaused = false;
        let startTime = null;
        let timer = null;
        let collectedData = [];
        let noteCounter = 1;

        // 模拟笔记数据
        const mockNotes = [
            {
                title: '超好看的秋季穿搭分享',
                author: '时尚达人小美',
                likes: 1234,
                image: 'https://picsum.photos/236/315?random=1'
            },
            {
                title: '这家咖啡店真的太棒了',
                author: '咖啡爱好者',
                likes: 567,
                image: 'https://picsum.photos/236/315?random=2'
            },
            {
                title: '周末去哪里玩？推荐几个好地方',
                author: '旅行小达人',
                likes: 890,
                image: 'https://picsum.photos/236/315?random=3'
            },
            {
                title: '简单易学的美妆教程',
                author: '美妆博主',
                likes: 2345,
                image: 'https://picsum.photos/236/315?random=4'
            },
            {
                title: '健康减肥餐制作方法',
                author: '健身教练',
                likes: 678,
                image: 'https://picsum.photos/236/315?random=5'
            }
        ];

        // 初始化页面
        function initPage() {
            generateMockNotes(8);
            log('页面初始化完成');
        }

        // 生成模拟笔记
        function generateMockNotes(count) {
            const mockPage = document.getElementById('mockPage');
            
            for (let i = 0; i < count; i++) {
                const noteData = mockNotes[i % mockNotes.length];
                const noteElement = createNoteElement(noteData, noteCounter++);
                mockPage.appendChild(noteElement);
            }
        }

        // 创建笔记元素
        function createNoteElement(noteData, index) {
            const section = document.createElement('section');
            section.className = 'note-item';
            section.setAttribute('data-testid', 'note-item');
            section.setAttribute('data-index', index);
            
            const noteId = `test${index}`;
            const noteUrl = `/explore/${noteId}`;
            
            section.innerHTML = `
                <div>
                    <a class="cover" href="${noteUrl}">
                        <img src="${noteData.image}" alt="${noteData.title}">
                    </a>
                    <div class="footer">
                        <a class="title" href="${noteUrl}">
                            <span>${noteData.title}</span>
                        </a>
                        <div class="author-wrapper">
                            <a class="author" href="/user/profile/test">
                                <img class="author-avatar" src="https://picsum.photos/20/20?random=${index}" alt="${noteData.author}">
                                <span class="name">${noteData.author}</span>
                            </a>
                            <span class="like-wrapper">
                                <span class="count">${noteData.likes}</span>
                            </span>
                        </div>
                    </div>
                </div>
            `;
            
            return section;
        }

        // 模拟content script
        window.mockContentScript = {
            collector: null,
            
            init() {
                this.collector = new XHSDataCollector();
                log('模拟content script初始化完成');
            },
            
            handleMessage(message) {
                if (!this.collector) this.init();
                
                switch (message.action) {
                    case 'getStatus':
                        return this.collector.getStatus();
                    case 'startCollection':
                        return this.collector.startCollection(message.settings || {});
                    case 'pauseCollection':
                        this.collector.pauseCollection();
                        return { success: true };
                    case 'resumeCollection':
                        this.collector.resumeCollection();
                        return { success: true };
                    case 'stopCollection':
                        this.collector.stopCollection();
                        return { success: true };
                    default:
                        return { success: false, error: '未知操作' };
                }
            }
        };

        // 控制函数
        async function startCollection() {
            try {
                const settings = {
                    scrollSpeed: 5,
                    scrollInterval: 3,
                    maxScrolls: 10,
                    smartStop: true,
                    collectTitle: true,
                    collectAuthor: true,
                    collectStats: true,
                    collectImages: true
                };
                
                const response = window.mockContentScript.handleMessage({
                    action: 'startCollection',
                    settings: settings
                });
                
                if (response && response.success) {
                    isRunning = true;
                    isPaused = false;
                    startTime = Date.now();
                    startTimer();
                    updateUI();
                    log('开始采集数据');
                } else {
                    log('启动采集失败: ' + (response.error || '未知错误'));
                }
            } catch (error) {
                log('启动采集失败: ' + error.message);
            }
        }

        function pauseCollection() {
            try {
                if (isPaused) {
                    window.mockContentScript.handleMessage({ action: 'resumeCollection' });
                    isPaused = false;
                    startTimer();
                    log('恢复采集');
                } else {
                    window.mockContentScript.handleMessage({ action: 'pauseCollection' });
                    isPaused = true;
                    stopTimer();
                    log('暂停采集');
                }
                updateUI();
            } catch (error) {
                log('暂停/恢复采集失败: ' + error.message);
            }
        }

        function stopCollection() {
            try {
                window.mockContentScript.handleMessage({ action: 'stopCollection' });
                isRunning = false;
                isPaused = false;
                stopTimer();
                updateUI();
                log('停止采集');
            } catch (error) {
                log('停止采集失败: ' + error.message);
            }
        }

        function addMoreNotes() {
            generateMockNotes(5);
            log('添加了5个新笔记');
        }

        // UI更新函数
        function updateUI() {
            const statusEl = document.getElementById('status');
            const startBtn = document.getElementById('startBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const stopBtn = document.getElementById('stopBtn');
            
            if (isRunning) {
                if (isPaused) {
                    statusEl.textContent = '已暂停';
                    statusEl.className = 'status paused';
                    pauseBtn.textContent = '继续';
                } else {
                    statusEl.textContent = '运行中';
                    statusEl.className = 'status running';
                    pauseBtn.textContent = '暂停';
                }
            } else {
                statusEl.textContent = '待启动';
                statusEl.className = 'status stopped';
            }
            
            startBtn.disabled = isRunning;
            pauseBtn.disabled = !isRunning;
            stopBtn.disabled = !isRunning;
            
            // 更新数据计数
            document.getElementById('dataCount').textContent = collectedData.length;
        }

        function startTimer() {
            if (timer) clearInterval(timer);
            
            timer = setInterval(() => {
                if (startTime) {
                    const elapsed = Date.now() - startTime;
                    const hours = Math.floor(elapsed / 3600000);
                    const minutes = Math.floor((elapsed % 3600000) / 60000);
                    const seconds = Math.floor((elapsed % 60000) / 1000);
                    
                    document.getElementById('runtime').textContent = 
                        `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                }
            }, 1000);
        }

        function stopTimer() {
            if (timer) {
                clearInterval(timer);
                timer = null;
            }
        }

        function updateDataPreview(data) {
            const previewEl = document.getElementById('dataPreview');
            
            if (!data || data.length === 0) {
                previewEl.innerHTML = '<div style="text-align: center; color: #999;">暂无数据</div>';
                return;
            }
            
            const html = data.slice(-3).reverse().map(item => `
                <div class="data-item">
                    <div><strong>${item.title || '无标题'}</strong></div>
                    <div>作者: ${item.author || '未知'} | 点赞: ${item.likes || 0}</div>
                    <div style="font-size: 10px; color: #999;">${new Date(item.timestamp).toLocaleTimeString()}</div>
                </div>
            `).join('');
            
            previewEl.innerHTML = html;
        }

        function log(message) {
            const logArea = document.getElementById('logArea');
            const time = new Date().toLocaleTimeString();
            logArea.innerHTML += `<div>[${time}] ${message}</div>`;
            logArea.scrollTop = logArea.scrollHeight;
        }

        function clearLogs() {
            document.getElementById('logArea').innerHTML = '';
        }

        // 监听采集器的消息
        if (window.chromeMessageListener) {
            // 模拟接收来自content script的消息
            setInterval(() => {
                if (isRunning && !isPaused) {
                    // 模拟数据更新
                    const mockData = {
                        url: `/explore/mock${Date.now()}`,
                        title: '模拟采集的笔记标题',
                        author: '模拟作者',
                        likes: Math.floor(Math.random() * 1000),
                        timestamp: Date.now()
                    };
                    
                    collectedData.push(mockData);
                    updateDataPreview(collectedData);
                    updateUI();
                    
                    if (collectedData.length % 5 === 0) {
                        log(`已采集 ${collectedData.length} 条数据`);
                    }
                }
            }, 2000);
        }

        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', () => {
            initPage();
            updateUI();
            log('测试页面加载完成');
        });
    </script>
</body>
</html>